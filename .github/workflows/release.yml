name: Auto Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Validate version matches plugin.json
        run: |
          PLUGIN_VERSION=$(python3 -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")
          TAG_VERSION="${{ steps.version.outputs.version }}"
          if [ "$PLUGIN_VERSION" != "$TAG_VERSION" ]; then
            echo "❌ Version mismatch!"
            echo "plugin.json: $PLUGIN_VERSION"
            echo "Git tag: $TAG_VERSION"
            exit 1
          fi
          echo "✓ Versions match: $PLUGIN_VERSION"

      - name: Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          # Automation Helper v${{ steps.version.outputs.version }}

          AI assistant for Power Automate and n8n workflows.

          ## Installation

          ```bash
          /plugin marketplace add therouxe/automation-helper
          /plugin install automation-helper
          ```

          ## What's in this release

          See [CHANGELOG.md](./CHANGELOG.md) for detailed changes.

          ## Status

          ⚠️ **Alpha Release** - In active development

          - ✅ Power Automate: Forms, Excel, Outlook, Teams (100%)
          - 🚧 Power Automate: SharePoint, OneDrive (20%)
          - ✅ n8n: Core nodes (basic coverage)
          - ❌ Make/Zapier: Not yet supported

          ## Contributing

          This is an open-source project. Contributions welcome!

          - 📚 Add documentation
          - 🐛 Report bugs
          - 💡 Suggest features
          - 🔧 Submit PRs

          See [CONTRIBUTING.md](./CONTRIBUTING.md) for details.

          ## Resources

          - [Installation Guide](./INSTALLATION.md)
          - [Usage Guide](./CLAUDE.md)
          - [Issues](https://github.com/therouxe/automation-helper/issues)
          - [Discussions](https://github.com/therouxe/automation-helper/discussions)

          ---

          **Feedback?** Open an [issue](https://github.com/therouxe/automation-helper/issues) or [discussion](https://github.com/therouxe/automation-helper/discussions)!
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') }}
          files: |
            .claude-plugin/plugin.json
            .claude-plugin/marketplace.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        run: |
          git tag -f latest
          git push origin latest --force
